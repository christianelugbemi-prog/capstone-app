deploy:
  needs: build-and-push
  runs-on: ubuntu-latest
  if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

  steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: Deploy to K3s via SSH
    uses: appleboy/ssh-action@master
    with:
      host: ${{ secrets.K3S_HOST }}
      username: ubuntu
      key: ${{ secrets.SSH_PRIVATE_KEY }}
      script: |
        set -e

        echo "==> Setting kubeconfig"
        export KUBECONFIG=/home/ubuntu/.kube/config

        echo "==> Checking Kubernetes connectivity"
        kubectl get nodes || { echo "Cluster not reachable"; exit 1; }

        echo "==> Updating image"
        kubectl set image deployment/capstone-app \
          capstone-app=${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
          -n ${{ env.K8S_NAMESPACE }}

        echo "==> Forcing new rollout"
        kubectl rollout restart deployment/capstone-app -n ${{ env.K8S_NAMESPACE }}

        echo "==> Waiting for rollout"
        kubectl rollout status deployment/capstone-app \
          -n ${{ env.K8S_NAMESPACE }} \
          --timeout=5m || {
            echo "Rollout FAILED. Showing logs..."
            kubectl describe deployment capstone-app -n ${{ env.K8S_NAMESPACE }}
            kubectl get pods -n ${{ env.K8S_NAMESPACE }}
            exit 1
          }

        echo "==> Deployment successful"
        kubectl get pods -n ${{ env.K8S_NAMESPACE }}
        kubectl get svc -n ${{ env.K8S_NAMESPACE }}
