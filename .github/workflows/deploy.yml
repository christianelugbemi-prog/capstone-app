    - name: Deploy to K3s
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.K3S_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Use the k3s kubeconfig
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

          # Apply deployment manifest with updated image
          /usr/local/bin/k3s kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: capstone-app
            namespace: ${{ env.K8S_NAMESPACE }}
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: capstone-app
            template:
              metadata:
                labels:
                  app: capstone-app
              spec:
                containers:
                - name: capstone-app
                  image: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
                  ports:
                  - containerPort: 80
                  resources:
                    requests:
                      cpu: 50m
                      memory: 64Mi
                    limits:
                      cpu: 200m
                      memory: 256Mi
          EOF

          # Wait for rollout
          /usr/local/bin/k3s kubectl rollout status deployment/capstone-app -n ${{ env.K8S_NAMESPACE }} --timeout=5m

          # Show deployment status
          /usr/local/bin/k3s kubectl get pods -n ${{ env.K8S_NAMESPACE }}
          /usr/local/bin/k3s kubectl get svc -n ${{ env.K8S_NAMESPACE }}
